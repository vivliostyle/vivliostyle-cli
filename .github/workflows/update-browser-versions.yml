name: Update Browser Versions

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  HUSKY: 0

jobs:
  update-browser-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Generate browser versions
        run: pnpm run generate:browser-versions

      - name: Check for changes
        id: check-changes
        run: |
          # Check if chrome or firefox versions have changed
          # (ignoring chromium-only changes)
          if git diff src/const.ts | grep -E '^\+.*\b(chrome|firefox):' > /dev/null; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Get browser versions
        if: steps.check-changes.outputs.has-changes == 'true'
        id: browser-versions
        run: |
          echo "## Updated Browser Versions" > browser-versions.txt
          echo "" >> browser-versions.txt
          echo "\`\`\`typescript" >> browser-versions.txt
          sed -n '/START DEFAULT_BROWSER_VERSIONS/,/END DEFAULT_BROWSER_VERSIONS/p' src/const.ts >> browser-versions.txt
          echo "\`\`\`" >> browser-versions.txt

          # Set output for PR body
          {
            echo 'versions<<EOF'
            cat browser-versions.txt
            echo EOF
          } >> $GITHUB_OUTPUT

          # Remove temporary file
          rm browser-versions.txt

      - name: Create changeset
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          # Extract Linux versions from const.ts
          CHROME_VERSION=$(sed -n '/chrome:/p' src/const.ts | grep -oP '"linux":"\K[^"]+')
          CHROMIUM_VERSION=$(sed -n '/chromium:/p' src/const.ts | grep -oP '"linux":"\K[^"]+')
          FIREFOX_VERSION=$(sed -n '/firefox:/p' src/const.ts | grep -oP '"linux":"\K[^"]+')

          cat > .changeset/update-browser-versions.md << EOF
          ---
          "@vivliostyle/cli": patch
          ---

          Update default browser versions

          - Chrome: $CHROME_VERSION
          - Chromium: $CHROMIUM_VERSION
          - Firefox: $FIREFOX_VERSION
          EOF

      - name: Create Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7.0.11
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update browser versions'
          committer: 'vivliostyle-bot[bot] <236058695+vivliostyle-bot[bot]@users.noreply.github.com>'
          author: 'vivliostyle-bot[bot] <236058695+vivliostyle-bot[bot]@users.noreply.github.com>'
          branch: update-browser-versions
          delete-branch: true
          title: 'Update browser versions'
          body: |
            This PR updates the default browser versions to the latest stable releases.

            ${{ steps.browser-versions.outputs.versions }}

            ---
            ðŸ¤– This PR was automatically generated by the [Update Browser Versions workflow](https://github.com/${{ github.repository }}/actions/workflows/update-browser-versions.yml)
          labels: dependencies
